
import sys
import os
import re 
""" 
Refactoring
- Regex in own function
"""
def main():
    if len(sys.argv) != 3:
        print(" Usage:\n python dataparser.py <type> <input file>")
        sys.exit(1)
    else:
        input = {
            "type": sys.argv[1],
            "file": sys.argv[2]
        }
        type_parser(input)

def type_parser(input):
    print_info("Input:" + str(input) + "\n")
    all_types = ["amass","knockpy"]
    if not os.path.isfile(input["file"]) or input["type"] not in all_types:
        print("File not found or Wrong type")
        sys.exit(1)
    else:
        if input["type"] in "amass":
            parse_amass(input["file"])
        if input["type"] in "knockpy":
            parse_knockpy(input["file"])

def parse_knockpy(file):
    print_info("File to open:" + file)
    if not os.path.isfile(file):
        print("File does not exist")
        sys.exit(1)
    else:
        f = open(file, "r")
        data = []
        for l in f.readlines():
            line = l.split()
            print(line)
            data.append(line)
        ips = open("/data/output/knockpy_ips.txt", "w")
        domains = open("/data/output/knockpy_domains.txt", "w")
        for array in data:
            for element in array:
                ip = re.match("^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$", element)
                domain = re.match("^[\w.-]+(?:\.[A-Za-z\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$", element)
                if ip is not None:
                    ips.write(ip.group()+"\n")
                if domain is not None:
                    domains.write(domain.group()+"\n")
        f.close()
        ips.close()
        domains.close()

      
def parse_amass(file):
    if not os.path.isfile(file):
        print("File does not exist")
        sys.exit(1)
    else:
        f = open(file, "r")
        data = []
        for l in f.readlines():
            line = l.split()
            data.append(line)
        ips = open("/data/output/amass_ips.txt", "w")
        domains = open("/data/output/amass_domains.txt", "w")
        for array in data:
            ips.write(array[1]+"\n")
            domains.write(array[0]+"\n")
        f.close()
        ips.close()
        domains.close()

def print_info(text):
    print("[*] " + text)
def print_error(text):
    print("[!] " + text)  

if __name__ == "__main__":
    main()
